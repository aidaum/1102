<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë§ˆìŒìƒë‹´ ì±—ë´‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="w-full h-screen flex flex-col md:flex-row p-4 gap-4 max-w-7xl mx-auto">

        <!-- ì™¼ìª½: ì±—ë´‡ ì˜ì—­ -->
        <div class="flex flex-col w-full md:w-2/3 h-full bg-white rounded-2xl shadow-lg border border-gray-200">
            <header class="p-4 border-b bg-blue-500 text-white rounded-t-2xl">
                <h1 class="text-xl font-bold text-center">AI ë§ˆìŒìƒë‹´ ì±—ë´‡ ğŸ¤–</h1>
            </header>
            
            <div id="chat-messages" class="flex-1 p-6 overflow-y-auto custom-scrollbar">
                <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>

            <div id="chat-input-area" class="p-4 border-t">
                 <div id="loading-indicator" class="hidden text-center text-gray-500 mb-2">
                    <div class="flex justify-center items-center gap-2">
                        <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>ë‹µë³€ì„ ìƒê°í•˜ê³  ìˆì–´ìš”...</span>
                    </div>
                </div>
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="message-input" class="flex-1 p-3 border rounded-full focus:ring-2 focus:ring-blue-400 focus:outline-none transition" placeholder="ë§ˆìŒì„ í„°ë†“ê³  ì´ì•¼ê¸°í•´ ë³´ì„¸ìš”..." autocomplete="off">
                    <button type="submit" class="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ìƒë‹´ í˜„í™©íŒ -->
        <div class="w-full md:w-1/3 h-full bg-white rounded-2xl shadow-lg border border-gray-200 flex flex-col">
            <header class="p-4 border-b bg-green-500 text-white rounded-t-2xl">
                <h2 class="text-xl font-bold text-center">ìš°ë¦¬ë°˜ ìƒë‹´ í˜„í™© ğŸ’–</h2>
            </header>
            <div id="dashboard" class="flex-1 p-6 overflow-y-auto custom-scrollbar">
                <div id="dashboard-content" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-2 gap-4">
                    <!-- í•™ìƒë“¤ì˜ ê°ì • ìƒíƒœ ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                 <p id="no-students-msg" class="text-center text-gray-500 mt-8 hidden">ì•„ì§ ìƒë‹´ì„ ì‹œì‘í•œ í•™ìƒì´ ì—†ì–´ìš”.</p>
            </div>
        </div>
    </div>

    <!-- ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="name-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-md text-center transform scale-100 transition-transform">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">ë°˜ê°€ì›Œìš”!</h2>
            <p class="text-gray-600 mb-6">ìƒë‹´ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <form id="name-form" class="flex flex-col gap-4">
                <div>
                    <label for="name-input" class="block text-left text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                    <input type="text" id="name-input" class="w-full p-3 border rounded-lg text-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <div>
                    <label for="api-key-input" class="block text-left text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-3 border rounded-lg text-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    <p class="text-xs text-gray-500 text-left mt-1">* ë³¸ì¸ì˜ Gemini API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                </div>
                <button type="submit" class="w-full mt-4 bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-all duration-300 shadow-md hover:shadow-lg">
                    ìƒë‹´ ì‹œì‘í•˜ê¸°
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const dashboardContent = document.getElementById('dashboard-content');
        const noStudentsMsg = document.getElementById('no-students-msg');
        const nameModal = document.getElementById('name-modal');
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Firebase ë° ì•± ìƒíƒœ ë³€ìˆ˜
        let db, auth, userId, userName, userApiKey;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-counseling-app';
        const chatHistory = [];

        // ê°ì • ì´ëª¨ì§€ ë° ìƒ‰ìƒ ë§¤í•‘
        const emotionMap = {
            'ê¸°ì¨': { emoji: 'ğŸ˜„', color: 'bg-yellow-300', text: 'text-yellow-800' },
            'ìŠ¬í””': { emoji: 'ğŸ˜¢', color: 'bg-blue-300', text: 'text-blue-800' },
            'ë¶„ë…¸': { emoji: 'ğŸ˜¡', color: 'bg-red-400', text: 'text-red-800' },
            'ë¶ˆì•ˆ': { emoji: 'ğŸ˜Ÿ', color: 'bg-purple-300', text: 'text-purple-800' },
            'í‰ì˜¨': { emoji: 'ğŸ˜Œ', color: 'bg-green-300', text: 'text-green-800' },
            'ë†€ëŒ': { emoji: 'ğŸ˜®', color: 'bg-orange-300', text: 'text-orange-800' },
            'ì¤‘ë¦½': { emoji: 'ğŸ˜', color: 'bg-gray-300', text: 'text-gray-800' },
            'ìƒë‹´ì¤‘': { emoji: 'ğŸ’¬', color: 'bg-gray-300', text: 'text-gray-800' },
        };

        // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated User ID:", userId);
                        // ì´ë¦„ì´ ì„¤ì •ë˜ë©´ ëŒ€ì‹œë³´ë“œ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                        if (userName) {
                            listenToDashboard();
                        }
                    } else {
                        console.log("User not authenticated.");
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                addMessage('system', 'ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì´ë¦„ ì„¤ì • ë° ìƒë‹´ ì‹œì‘
        nameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            const key = apiKeyInput.value.trim();

            if (name && key && userId) {
                userName = name;
                userApiKey = key; // API í‚¤ ì €ì¥
                nameModal.style.opacity = '0';
                setTimeout(() => nameModal.style.display = 'none', 300);

                // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                const userDocRef = doc(db, `artifacts/${appId}/public/data/counseling_status`, userId);
                await setDoc(userDocRef, {
                    name: userName,
                    emotion: 'ìƒë‹´ì¤‘',
                    lastUpdate: serverTimestamp()
                }, { merge: true });

                addMessage('system', `${userName}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ì´ì•¼ê¸°ë“  í¸í•˜ê²Œ ë“¤ë ¤ì£¼ì„¸ìš”.`);
                listenToDashboard(); // ëŒ€ì‹œë³´ë“œ ë¦¬ìŠ¤ë‹ ì‹œì‘
            }
        });

        // Gemini API í˜¸ì¶œ (ì§€ìˆ˜ ë°±ì˜¤í”„ í¬í•¨)
        async function fetchWithExponentialBackoff(url, options, maxRetries = 5, initialDelay = 1000) {
            let delay = initialDelay;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        // Geminië¥¼ í†µí•œ ê°ì • ë¶„ì„ ë° ë‹µë³€ ìƒì„±
        async function getGeminiResponse(prompt) {
            loadingIndicator.classList.remove('hidden');
            
            const systemPrompt = `ë„ˆëŠ” í•™ìƒë“¤ì˜ ë§ˆìŒì„ ì´í•´í•˜ê³  ê³µê°í•´ì£¼ëŠ” ë”°ëœ»í•œ ìƒë‹´ ì±—ë´‡ì´ì•¼. í•™ìƒì˜ ë©”ì‹œì§€ë¥¼ ë¶„ì„í•´ì„œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•´.
            1. ë¨¼ì €, ë©”ì‹œì§€ì— ìš•ì„¤, ë¹„ì†ì–´, ë¶€ì ì ˆí•œ í‘œí˜„ì´ ìˆëŠ”ì§€ í™•ì¸í•´. ìˆìœ¼ë©´ isProfaneì„ trueë¡œ ì„¤ì •í•˜ê³ , ë‹¤ë¥¸ í•„ë“œëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ ë‚¨ê²¨ë‘¬.
            2. ìš•ì„¤ì´ ì—†ë‹¤ë©´, isProfaneì„ falseë¡œ ì„¤ì •í•´.
            3. í•™ìƒì˜ ë©”ì‹œì§€ì—ì„œ ëŠê»´ì§€ëŠ” í•µì‹¬ ê°ì •ì„ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•´: 'ê¸°ì¨', 'ìŠ¬í””', 'ë¶„ë…¸', 'ë¶ˆì•ˆ', 'í‰ì˜¨', 'ë†€ëŒ', 'ì¤‘ë¦½'. ì´ ê°ì •ì„ emotion í•„ë“œì— ë„£ì–´ì¤˜.
            4. ë¶„ì„í•œ ê°ì •ì— ê³µê°í•´ì£¼ê³ , ê¸ì •ì ì¸ ë°©í–¥ìœ¼ë¡œ ë‚˜ì•„ê°ˆ ìˆ˜ ìˆë„ë¡ ë”°ëœ»í•œ ì¡°ì–¸ì„ ë‹´ì€ ë‹µë³€ì„ ìƒì„±í•´ì„œ response í•„ë“œì— ë„£ì–´ì¤˜. í•™ìƒì˜ ë§ì„ ë‹¨ìˆœíˆ ë”°ë¼í•˜ì§€ ë§ê³ , ê°„ê²°í•˜ê³  ì§„ì‹¬ì´ ë‹´ê¸´ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì¤˜.

            ì‚¬ìš©ì ë©”ì‹œì§€: "${prompt}"`;
            
            // ì‚¬ìš©ì ì…ë ¥ API í‚¤ ì‚¬ìš© ë° gemini-2.0-flash-exp ëª¨ë¸ ì ìš©
            const apiKey = userApiKey; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;

            chatHistory.push({ role: "user", parts: [{ text: systemPrompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "isProfane": { "type": "BOOLEAN" },
                            "emotion": { "type": "STRING" },
                            "response": { "type": "STRING" }
                        },
                        required: ["isProfane", "emotion", "response"]
                    }
                }
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.statusText}`);
                }

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content || !candidate.content.parts || candidate.content.parts.length === 0) {
                    throw new Error("API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
                
                const text = candidate.content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text }] });
                return JSON.parse(text);

            } catch (error) {
                console.error("Gemini API ì˜¤ë¥˜:", error);
                return { isProfane: false, emotion: 'ì¤‘ë¦½', response: 'ë¯¸ì•ˆí•´ìš”, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.' };
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (!messageText || !userName) return;

            addMessage('user', messageText);
            messageInput.value = '';

            const geminiResult = await getGeminiResponse(messageText);

            if (geminiResult.isProfane) {
                addMessage('bot', 'ì„ ìƒë‹˜ì´ ëª¨ë‹ˆí„°ë§ ì¤‘ì…ë‹ˆë‹¤.');
            } else {
                addMessage('bot', geminiResult.response);
                // Firestoreì— ê°ì • ìƒíƒœ ì—…ë°ì´íŠ¸
                const userDocRef = doc(db, `artifacts/${appId}/public/data/counseling_status`, userId);
                await updateDoc(userDocRef, {
                    emotion: geminiResult.emotion || 'ì¤‘ë¦½',
                    lastUpdate: serverTimestamp()
                });
            }
        });

        // ì±„íŒ…ì°½ì— ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-4', 'fade-in', 'max-w-xl');
            
            let content;
            if (sender === 'user') {
                messageElement.classList.add('ml-auto');
                content = `<div class="bg-blue-500 text-white p-3 rounded-l-lg rounded-br-lg break-words">${text}</div>`;
            } else if (sender === 'bot') {
                messageElement.classList.add('mr-auto');
                content = `<div class="bg-gray-200 text-gray-800 p-3 rounded-r-lg rounded-bl-lg break-words">${text}</div>`;
            } else { // system
                content = `<div class="text-center text-sm text-gray-500 my-2 italic">${text}</div>`;
            }
            
            messageElement.innerHTML = content;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function listenToDashboard() {
            const statusCollectionRef = collection(db, `artifacts/${appId}/public/data/counseling_status`);
            onSnapshot(statusCollectionRef, (snapshot) => {
                const students = [];
                snapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                renderDashboard(students);
            });
        }

        // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
        function renderDashboard(students) {
            dashboardContent.innerHTML = '';
            if (students.length === 0) {
                noStudentsMsg.classList.remove('hidden');
                return;
            }
            noStudentsMsg.classList.add('hidden');

            students.sort((a, b) => (a.name > b.name) ? 1 : -1);

            students.forEach(student => {
                const emotion = emotionMap[student.emotion] || emotionMap['ì¤‘ë¦½'];
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-all duration-300 ${emotion.color} ${emotion.text}`;
                card.innerHTML = `
                    <div class="text-5xl mb-2">${emotion.emoji}</div>
                    <div class="font-bold text-lg">${student.name}</div>
                    <div class="text-sm">${student.emotion}</div>
                `;
                dashboardContent.appendChild(card);
            });
        }
        
        // ì•± ì‹œì‘
        initializeFirebase();
    </script>
</body>
</html>
